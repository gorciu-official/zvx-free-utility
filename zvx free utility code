import os
import sys
import ctypes
import subprocess
import winreg
import time

def is_admin():
    try: return ctypes.windll.shell32.IsUserAnAdmin()
    except: return False

def run_as_admin():
    if not is_admin():
        ctypes.windll.shell32.ShellExecuteW(None, "runas", sys.executable, " ".join(sys.argv), None, 1)
        sys.exit()

def reg_set(hkey, path, name, value, vtype=winreg.REG_DWORD):
    try:
        key = winreg.CreateKeyEx(hkey, path, 0, winreg.KEY_SET_VALUE)
        winreg.SetValueEx(key, name, 0, vtype, value)
        winreg.CloseKey(key)
    except: pass

def create_restore_point():
    print("\n[!] TWORZENIE PUNKTU PRZYWRACANIA SYSTEMU...")
    cmd = 'powershell -Command "Checkpoint-Computer -Description \'ZVX_Before_Optimization\' -RestorePointType MODIFY_SETTINGS"'
    subprocess.run(cmd, shell=True)
    print("[OK] Punkt przywracania został utworzony.")

def restore_system():
    print("\n[!] OTWIERANIE PANELU PRZYWRACANIA SYSTEMU...")
    os.system("rstrui.exe")

def fortnite_fps_beast():
    print("\n[>>>] EXTREME FPS & INPUT LAG OPTIMIZER...")
    # 1-5: Podstawowe optymalizacje z poprzedniego kodu
    reg_set(winreg.HKEY_LOCAL_MACHINE, r"SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile", "SystemResponsiveness", 0)
    reg_set(winreg.HKEY_LOCAL_MACHINE, r"SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile", "NetworkThrottlingIndex", 0xFFFFFFFF)
    reg_set(winreg.HKEY_CURRENT_USER, r"System\GameConfigStore", "GameDVR_Enabled", 0)
    reg_set(winreg.HKEY_CURRENT_USER, r"System\GameConfigStore", "GameDVR_FSEBehaviorMode", 2)
    reg_set(winreg.HKEY_CURRENT_USER, r"Control Panel\Mouse", "MouseSpeed", "0", winreg.REG_SZ)
    
    # 6-10: Dodatkowe agresywne tweaki pod FPS
    reg_set(winreg.HKEY_LOCAL_MACHINE, r"SYSTEM\CurrentControlSet\Control\PriorityControl", "Win32PrioritySeparation", 38)
    reg_set(winreg.HKEY_LOCAL_MACHINE, r"SOFTWARE\Microsoft\PolicyManager\default\ApplicationManagement\AllowAllTrustedApps", "value", 1)
    reg_set(winreg.HKEY_LOCAL_MACHINE, r"SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management", "LargeSystemCache", 1)
    reg_set(winreg.HKEY_LOCAL_MACHINE, r"SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management", "IoPageLockLimit", 983040)
    reg_set(winreg.HKEY_LOCAL_MACHINE, r"SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games", "Scheduling Category", "High", winreg.REG_SZ)
    print("[OK] FPS Beast Mode aktywowany!")

def windows_debloat_full():
    print("\n[>>>] AGRESYWNY WINDOWS DEBLOAT...")
    # Usługi i telemetria z poprzedniego kodu
    services = ["DiagTrack", "SysMain", "WSearch", "dmwappushservice", "MapsBroker", "XblAuthManager", "XblGameSave"]
    for s in services:
        os.system(f"sc stop {s} >nul 2>&1 && sc config {s} start= disabled >nul 2>&1")
    
    # Usuwanie aplikacji OneDrive i Cortana
    reg_set(winreg.HKEY_LOCAL_MACHINE, r"SOFTWARE\Policies\Microsoft\Windows\Windows Search", "AllowCortana", 0)
    os.system("taskkill /f /im OneDrive.exe >nul 2>&1")
    
    # Ultimate Power Plan
    os.system("powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61 >nul")
    os.system("powercfg -setactive e9a42b02-d5df-448d-aa00-03f14749eb61 >nul")
    print("[OK] Debloat zakończony!")

def system_cleaner():
    print("\n[>>>] GŁĘBOKIE CZYSZCZENIE SYSTEMU...")
    os.system('del /q /f /s %temp%\* >nul 2>&1')
    os.system('del /q /f /s C:\Windows\Temp\* >nul 2>&1')
    os.system('del /q /f /s C:\Windows\Prefetch\* >nul 2>&1')
    os.system('ipconfig /flushdns >nul')
    print("[OK] System wyczyszczony!")

def main_menu():
    while True:
        os.system('cls')
        print("========================================")
        print("      ZVX FREE UTILITY PANEL v5.0")
        print("      PRO GAMING & SYSTEM TUNER")
        print("========================================")
        print("[1] CREATE RESTORE POINT (Zalecane!)")
        print("[2] FORTNITE FPS BEAST (FPS/Input Lag)")
        print("[3] TOTAL DEBLOATER (Spyware/Apps)")
        print("[4] DEEP CLEANER (Temp/Cache)")
        print("[5] RESTORE SYSTEM (Przywracanie)")
        print("[6] ALL IN ONE (Full Boost)")
        print("[7] EXIT")
        print("========================================")
        
        choice = input("Wybierz opcję: ")
        
        if choice == "1": create_restore_point()
        elif choice == "2": fortnite_fps_beast()
        elif choice == "3": windows_debloat_full()
        elif choice == "4": system_cleaner()
        elif choice == "5": restore_system()
        elif choice == "6":
            create_restore_point()
            fortnite_fps_beast()
            windows_debloat_full()
            system_cleaner()
        elif choice == "7": break
        
        input("\nKliknij Enter, aby kontynuować...")

if __name__ == "__main__":
    ctypes.windll.kernel32.SetConsoleTitleW("ZVX Free Utility Panel")
    run_as_admin()
    main_menu()
